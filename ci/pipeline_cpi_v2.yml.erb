---
groups:
  - name: all-jobs
    jobs:
    - build-cpi
    - compile-bosh-release
    - integration<% [1,2].each do |c| [1,2].each do |d| [1,2].each do |s| %>
    - bats-cpi<%= c %>-dir<%= d %>-sc<%= s %><% end; end; end %><% [1,2].each do |c| [1,2].each do |d| [1,2].each do |s| %>
    - end-2-end-cpi<%= c %>-dir<%= d %>-sc<%= s %><% end; end; end %>
  - name: bosh-aws-cpi-v2
    jobs:
    - build-cpi
    - compile-bosh-release
    - integration
  - name: bats
    jobs:<% [1,2].each do |c| [1,2].each do |d| [1,2].each do |s| %>
    - bats-cpi<%= c %>-dir<%= d %>-sc<%= s %><% end; end; end %>
  - name: e2e
    jobs:<% [1,2].each do |c| [1,2].each do |d| [1,2].each do |s| %>
    - end-2-end-cpi<%= c %>-dir<%= d %>-sc<%= s %><% end; end; end %>

shared:
  - &prepare-director
    task: prepare-director
    file: pipelines/shared/tasks/prepare-director.yml
    params: &prepare-director-params
      INFRASTRUCTURE:     aws
      DIRECTOR_VARS_FILE: {{aws_director_vars_file}}

  - &deploy-director
    task: deploy-director
    file: pipelines/shared/tasks/deploy-director.yml

  - &run-bats
    task: run-bats
    file: pipelines/shared/tasks/run-bats.yml
    params:
      INFRASTRUCTURE:     aws
      STEMCELL_NAME:      bosh-aws-xen-hvm-ubuntu-trusty-go_agent
      BAT_INFRASTRUCTURE: aws
      BAT_NETWORKING:     dynamic
      BAT_RSPEC_FLAGS:    "--tag ~multiple_manual_networks --tag ~root_partition"

  - &run-end-2-end
    task: run-e2e
    file: bosh-cpi-src/ci/tasks/run-e2e.yml
    params:
      BOSH_AWS_KMS_KEY_ARN: {{aws_kms_key_arn}}

  - &create-environment
    put: environment
    params:
      delete_on_failure: true
      generate_random_name: true
      terraform_source: bosh-cpi-src/ci/assets/terraform
      override_files: [bosh-cpi-src/ci/assets/terraform/e2e/e2e.tf]

  - &destroy-environment
    put: environment
    params:
      action: destroy
      env_name_file: environment/name
      terraform_source: bosh-cpi-src/ci/assets/terraform
    get_params:
      action: destroy

  - &ensure-terminated
    task: ensure-terminated
    file: bosh-cpi-src/ci/tasks/ensure-terminated.yml
    params:
      AWS_ACCESS_KEY_ID:     {{aws_access_key}}
      AWS_SECRET_ACCESS_KEY: {{aws_secret_key}}
      AWS_DEFAULT_REGION:    {{aws_region}}

  - &teardown
    task: teardown
    file: pipelines/shared/tasks/teardown.yml

jobs:
#  - name: build-candidate
#    serial: true
#    plan:
#      - aggregate:
#        - {trigger: true, get: bosh-cpi-src, resource: bosh-cpi-src-in}
#        - {trigger: false, get: version-semver, params: {bump: patch}}
#        - {trigger: false, get: bosh-cli}
#      - put: version-semver
#        params: {file: version-semver/number}
#      - task: build
#        file: bosh-cpi-src/ci/tasks/build-candidate.yml
#      - put: bosh-cpi-dev-artifacts
#        params: {file: candidate/*.tgz}

  - name: build-cpi
    serial: true
    plan:
      - aggregate:
        - {trigger: true, get: bosh-cpi-src, resource: bosh-cpi-src}
        - {trigger: false, get: version-semver, params: {bump: patch}}
        - {trigger: false, get: bosh-cli}
      - put: version-semver
        params: {file: version-semver/number}
      - task: build
        file: bosh-cpi-src/ci/tasks/build-candidate.yml
      - put: bosh-cpi-dev-artifacts-v2
        params: {file: candidate/*.tgz}

  - name: integration
    serial: true
    plan:
      - aggregate:
        - {trigger: true, passed: [build-cpi], get: bosh-cpi-src, resource: bosh-cpi-src}
      - <<: *create-environment
      #- aggregate:
      - task: test-cpi-v2
        file: bosh-cpi-src/ci/tasks/run-integration.yml
        params:
          AWS_ACCESS_KEY_ID:                       {{aws_access_key__cpi}}
          AWS_SECRET_ACCESS_KEY:                   {{aws_secret_key__cpi}}
          BOSH_AWS_PERMISSIONS_AUDITOR_KEY_ID:     {{aws_access_key__auditor}}
          BOSH_AWS_PERMISSIONS_AUDITOR_SECRET_KEY: {{aws_secret_key__auditor}}
          AWS_DEFAULT_REGION:                      {{aws_region__primary}}
          BOSH_AWS_KMS_KEY_ARN:                    {{aws_kms_key_arn}}
          BOSH_AWS_KMS_KEY_ARN_OVERRIDE:           {{aws_kms_key_arn_override}}
          BOSH_AWS_CPI_API_VERSION: 2
      - <<: *destroy-environment
      - <<: *create-environment
      - task: test-cpi-v1
        file: bosh-cpi-src/ci/tasks/run-integration.yml
        params:
          AWS_ACCESS_KEY_ID:                       {{aws_access_key__cpi}}
          AWS_SECRET_ACCESS_KEY:                   {{aws_secret_key__cpi}}
          BOSH_AWS_PERMISSIONS_AUDITOR_KEY_ID:     {{aws_access_key__auditor}}
          BOSH_AWS_PERMISSIONS_AUDITOR_SECRET_KEY: {{aws_secret_key__auditor}}
          AWS_DEFAULT_REGION:                      {{aws_region__primary}}
          BOSH_AWS_KMS_KEY_ARN:                    {{aws_kms_key_arn}}
          BOSH_AWS_KMS_KEY_ARN_OVERRIDE:           {{aws_kms_key_arn_override}}
          BOSH_AWS_CPI_API_VERSION: 1
    ensure:
      do:
        - <<: *ensure-terminated
        - <<: *destroy-environment

  - name: compile-bosh-release
    serial: true
    plan:
      - aggregate:
          - {get: bosh-dev-version, resource: bosh-dev-version}
          - {get: bosh-src, trigger: true, resource: bosh-src-in}
          - {get: bosh-cli}
          - {get: bosh-cpi-src, resource: bosh-cpi-src}
      - task: compile-bosh-release
        file: bosh-cpi-src/ci/tasks/build-bosh-dev.yml
      - put: bosh-release
        resource: bosh-dev-tarballs
        params:
          file: "release/bosh-dev-release-for-cpi-refactor.tgz"

<%
stemcell_resources = [
  [{name: 'stemcell', resource: 'precompiled-stemcell-v1'}, {name: 'heavy-stemcell', resource: 'heavy-ubuntu-stemcell-v1'}],
  [{name: 'stemcell', resource: 'precompiled-ubuntu-stemcell-v2'},{name: 'heavy-stemcell', resource: 'heavy-ubuntu-stemcell-v2'}]
]
director_resources = [
  {name: 'bosh-release', resource: 'precompiled-bosh-release', ops_file: ''},
  {name: 'bosh-release', resource: 'bosh-dev-tarballs', passed: 'compile-bosh-release', ops_file: '-o pipelines/aws/assets/ops/director_cpi_version.yml'}
]
# we won't really have two of these -- it's the same code, but the above changes the version
cpi_resources = [
  {name: 'cpi-release', resource: 'bosh-cpi-dev-artifacts-v2', passed: 'build-cpi'},
  {name: 'cpi-release', resource: 'bosh-cpi-dev-artifacts-v2', passed: 'build-cpi'}
]

stemcell_resources.each_with_index do |s, s_idx|
  director_resources.each_with_index do |d, d_idx|
    cpi_resources.each_with_index do |c, c_idx|
%>
  - name: end-2-end-cpi<%= c_idx+1 %>-dir<%= d_idx+1 %>-sc<%= s_idx+1 %>
    serial: true
    plan:
    - aggregate:
      - {get: <%= c[:name] %>, trigger: true,  resource: <%= c[:resource] %>, passed: [bats-cpi<%= c_idx+1 %>-dir<%= d_idx+1 %>-sc<%= s_idx+1 %>]}
      - {get: <%= d[:name] %>, trigger: false, resource: <%= d[:resource] %>, passed: [bats-cpi<%= c_idx+1 %>-dir<%= d_idx+1 %>-sc<%= s_idx+1 %>]}
      - {get: bosh-cpi-src,    trigger: false, resource: bosh-cpi-src, passed: [build-cpi]}
      - {get: <%= s.first[:name] %>, trigger: false, resource: <%= s.first[:resource] %>}
      - {get: <%= s[1][:name] %>,  trigger: false, resource: <%= s[1][:resource] %>}
      - {get: bosh-deployment, trigger: false}
      - {get: pipelines,       trigger: true}
      - {get: bosh-cli,        trigger: false}
    - <<: *create-environment
    - do:
      - <<: *prepare-director
        params:
          <<: *prepare-director-params
          OPTIONAL_OPS_FILE:  |
            -o bosh-deployment/external-ip-with-registry-not-recommended.yml
            -o pipelines/shared/assets/ops/remove-provider-cert.yml
            -o bosh-deployment/experimental/blobstore-https.yml
            -o pipelines/aws/assets/ops/iam-instance-profile-ops-file.yml
            -o bosh-deployment/experimental/bpm.yml
            <%= d[:ops_file]%>
          CPI_VERSION: <%= c_idx+1 %>
      - do:
          - <<: *deploy-director
          - <<: *run-end-2-end
        ensure:
          do:
            - <<: *teardown
            - <<: *ensure-terminated
      ensure:
        do:
          - <<: *destroy-environment
  - name: bats-cpi<%= c_idx+1 %>-dir<%= d_idx+1 %>-sc<%= s_idx+1 %>
    serial: true
    plan:
      - aggregate:
        - {get: <%= c[:name] %>, trigger: true,  resource: <%= c[:resource] %>, passed: [<%= c[:passed]%>]}
        - {get: <%= d[:name] %>, trigger: false, resource: <%= d[:resource] %>, passed: [<%= d[:passed]%>]}
        - {get: bosh-cpi-src,    trigger: false, resource: bosh-cpi-src, passed: [build-cpi]}
        - {get: <%= s.first[:name] %>, trigger: false, resource: <%= s.first[:resource] %>}
        - {get: bosh-deployment, trigger: false}
        - {get: pipelines,       trigger: true}
        - {get: bosh-cli,        trigger: false}
        - {get: bats,            trigger: false}
      - <<: *create-environment
      - do:
        - <<: *prepare-director
          params:
            <<: *prepare-director-params
            OPTIONAL_OPS_FILE:  |
              -o pipelines/shared/assets/ops/remove-hm.yml
              -o bosh-deployment/external-ip-with-registry-not-recommended.yml
              -o bosh-deployment/experimental/blobstore-https.yml
              -o pipelines/shared/assets/ops/remove-provider-cert.yml
              -o bosh-deployment/experimental/bpm.yml
              <%= d[:ops_file]%>
            CPI_VERSION: <%= c_idx+1 %>
        - do:
            - <<: *deploy-director
            - <<: *run-bats
          ensure:
            do:
              - <<: *teardown
              - <<: *ensure-terminated
        ensure:
          do:
            - <<: *destroy-environment
<%
    end
  end
end
%>
resource_types:
  - name: terraform_type
    type: docker-image
    source:
      repository: ljfranklin/terraform-resource

resources:
  - name: bosh-cpi-dev-artifacts-v2
    type: s3
    source:
      regexp: bosh-aws-cpi-(\d+\.\d+\.\d+)\.tgz
      bucket: bosh-toronto-cpi-v2
      region_name: ((s3_aws_cpi_pipeline_bucket_region))
      access_key_id: ((aws_access_key))
      secret_access_key: ((aws_secret_key))
  - name: bosh-cpi-src
    type: git
    source:
      uri: https://github.com/cloudfoundry-incubator/bosh-aws-cpi-release.git
      branch: cpi-api-version
      ignore_paths:
        - .final_builds/**/*.yml
        - releases/**/*.yml
  - name: bosh-src-in
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh.git
      branch: external-cpi-refactor
      ignore_paths:
        - .final_builds/**/*.yml
        - releases/**/*.yml
  - name: version-semver
    type: semver
    source:
      key:               current-version # dev-release version
      bucket:            bosh-toronto-cpi-v2
      access_key_id:     {{aws_access_key}}
      secret_access_key: {{aws_secret_key}}
  - name: bosh-dev-version
    type: semver
    source:
      bucket: bosh-toronto-cpi-v2
      key: version
      access_key_id: {{aws_access_key}}
      secret_access_key: {{aws_secret_key}}
  - name: bosh-dev-tarballs
    type: s3
    source:
      bucket: bosh-toronto-director-v2
      access_key_id: {{aws_access_key}}
      secret_access_key: {{aws_secret_key}}
      versioned_file: "bosh-dev-release.tgz"
      region_name: us-west-1
  - name: environment
    type: terraform_type
    source:
      storage:
        access_key_id:     {{aws_access_key__primary}}
        secret_access_key: {{aws_secret_key__primary}}
        bucket:            {{terraform_bucket}}
        bucket_path:       terraform-state
      vars:
        access_key: {{aws_access_key__primary}}
        secret_key: {{aws_secret_key__primary}}
        region:     {{aws_region__primary}}
        public_key: {{cpi_pipeline_public_key}}
  - name: bosh-cli
    type: s3
    source:
      regexp: bosh-cli-([0-9.]+)-linux-amd64
      bucket: bosh-cli-artifacts
      region_name: us-east-1
  - name: pipelines
    type: git
    source:
      uri: https://github.com/cloudfoundry-incubator/bosh-cpi-certification
      branch: cpi_version
  - name: precompiled-stemcell-v1
    type: s3
    source:
      bucket: bosh-aws-light-stemcells
      regexp: light-bosh-stemcell-(3363.12)-aws-xen-hvm-ubuntu-trusty-go_agent.tgz
      region_name: us-east-1
  - name: heavy-ubuntu-stemcell-v1
    type: bosh-io-stemcell
    source:
      name: &heavy-ubuntu-stemcell-v1 bosh-aws-xen-ubuntu-trusty-go_agent
      force_regular: true
#  - name: precompiled-stemcell-v2
#    type: s3
#    source:
#      bucket: bosh-toronto-bag
#      regexp: light-bosh-stemcell-(3363.12)-aws-xen-hvm-ubuntu-trusty-go_agent.tgz
#      region_name: us-east-1
  - name: heavy-ubuntu-stemcell-v2
    type: s3
    source:
      bucket: bosh-toronto-bag
      regexp: bosh-registry-removal/stemcells/aws/bosh-stemcell-(.*)-aws-xen-hvm-ubuntu-trusty-go_agent.tgz
  - name: precompiled-ubuntu-stemcell-v2
    type: s3
    source:
      access_key_id: {{aws_access_key}}
      bucket: bosh-toronto-bag
      regexp: bosh-light-aws-stemcell-v2-toronto/TEST_LIGHT_STEMCELL_v2_light-bosh-stemcell-(.*)-v2-aws-xen-hvm-ubuntu-trusty-go_agent.tgz
      secret_access_key: {{aws_secret_key}}
  - name: bats
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh-acceptance-tests.git
      branch: master
  - name: bosh-deployment
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh-deployment
      branch: master
  - name: precompiled-bosh-release
    type: s3
    source:
      bucket: bosh-compiled-release-tarballs
      regexp: bosh-(262)-ubuntu-trusty-3421.3-20170601-224719-625105306-20170601224724.tgz
